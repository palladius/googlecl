<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>service.py</title>
  <link rel="stylesheet" href="../../../pycco.css">
</head>
<body>
<div id="background"></div>
<div id='container'>
  <div class='section'>
    <div class='docs'><h1>service.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>Copyright (C) 2010 Google Inc.</p>
<p>Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<pre><code> http://www.apache.org/licenses/LICENSE-2.0
</code></pre>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
Service details and instances for the Picasa service.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">with_statement</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;tom.h.miller@gmail.com (Tom Miller)&#39;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">gdata.photos</span>
<span class="kn">from</span> <span class="nn">gdata.photos.service</span> <span class="kn">import</span> <span class="n">PhotosService</span><span class="p">,</span> <span class="n">GooglePhotosException</span>

<span class="kn">import</span> <span class="nn">googlecl</span>
<span class="kn">import</span> <span class="nn">googlecl.base</span>
<span class="kn">import</span> <span class="nn">googlecl.service</span>
<span class="kn">import</span> <span class="nn">googlecl.picasa</span>
<span class="kn">import</span> <span class="nn">googlecl.calendar.date</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>Shortening the names of these guys.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">safe_encode</span> <span class="o">=</span> <span class="n">googlecl</span><span class="o">.</span><span class="n">safe_encode</span>
<span class="n">safe_decode</span> <span class="o">=</span> <span class="n">googlecl</span><span class="o">.</span><span class="n">safe_decode</span>

<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">googlecl</span><span class="o">.</span><span class="n">picasa</span><span class="o">.</span><span class="n">LOGGER_NAME</span><span class="p">)</span>
<span class="n">SUPPORTED_VIDEO_TYPES</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;wmv&#39;</span><span class="p">:</span> <span class="s">&#39;video/x-ms-wmv&#39;</span><span class="p">,</span>
                         <span class="s">&#39;avi&#39;</span><span class="p">:</span> <span class="s">&#39;video/avi&#39;</span><span class="p">,</span>
                         <span class="s">&#39;3gp&#39;</span><span class="p">:</span> <span class="s">&#39;video/3gpp&#39;</span><span class="p">,</span>
                         <span class="s">&#39;mov&#39;</span><span class="p">:</span> <span class="s">&#39;video/quicktime&#39;</span><span class="p">,</span>
                         <span class="s">&#39;qt&#39;</span><span class="p">:</span> <span class="s">&#39;video/quicktime&#39;</span><span class="p">,</span>
                         <span class="s">&#39;mp4&#39;</span><span class="p">:</span> <span class="s">&#39;video/mp4&#39;</span><span class="p">,</span>
                         <span class="s">&#39;mpa&#39;</span><span class="p">:</span> <span class="s">&#39;video/mpeg&#39;</span><span class="p">,</span>
                         <span class="s">&#39;mpe&#39;</span><span class="p">:</span> <span class="s">&#39;video/mpeg&#39;</span><span class="p">,</span>
                         <span class="s">&#39;mpeg&#39;</span><span class="p">:</span> <span class="s">&#39;video/mpeg&#39;</span><span class="p">,</span>
                         <span class="s">&#39;mpg&#39;</span><span class="p">:</span> <span class="s">&#39;video/mpeg&#39;</span><span class="p">,</span>
                         <span class="s">&#39;mpv2&#39;</span><span class="p">:</span> <span class="s">&#39;video/mpeg&#39;</span><span class="p">,</span>
                         <span class="s">&#39;mpeg4&#39;</span><span class="p">:</span> <span class="s">&#39;video/mpeg4&#39;</span><span class="p">,}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>XXX gdata.photos.service contains a very strange check against (outdated)
allowed MIME types. This is a hack to allow videos to be uploaded.
We're creating a list of the allowed video types stripped of the initial
'video/', eliminating duplicates via set(), then converting to tuple()
since that's what gdata.photos.service uses.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="n">gdata</span><span class="o">.</span><span class="n">photos</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">SUPPORTED_UPLOAD_TYPES</span> <span class="o">+=</span> \
   <span class="nb">tuple</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">vtype</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">vtype</span> <span class="ow">in</span> <span class="n">SUPPORTED_VIDEO_TYPES</span><span class="o">.</span><span class="n">values</span><span class="p">()]))</span>
<span class="n">DOWNLOAD_VIDEO_TYPES</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;swf&#39;</span><span class="p">:</span> <span class="s">&#39;application/x-shockwave-flash&#39;</span><span class="p">,</span>
                        <span class="s">&#39;mp4&#39;</span><span class="p">:</span> <span class="s">&#39;video/mpeg4&#39;</span><span class="p">,}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>Extends gdata.photos.service.PhotosService for the command line.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">PhotosServiceCL</span><span class="p">(</span><span class="n">PhotosService</span><span class="p">,</span> <span class="n">googlecl</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">BaseServiceCL</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>This class adds some features focused on using Picasa via an installed app
with a command line interface.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>Constructor.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">PhotosService</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">googlecl</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">BaseServiceCL</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                            <span class="n">googlecl</span><span class="o">.</span><span class="n">picasa</span><span class="o">.</span><span class="n">SECTION_HEADER</span><span class="p">,</span>
                                            <span class="n">config</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>Build a list of entries of either photos or albums.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">build_entry_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="n">titles</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                       <span class="n">force_photos</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">photo_title</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>If no title is specified, entries will be of photos matching the query.
If no query is specified, entries will be of albums matching the title.
If both title and query are specified, entries will be of photos matching
  the query that are also in albums matching the title.</p>
<p>Keyword arguments:
  user: Username of the owner of the albums / photos (Default 'default').
  titles: list Titles of the albums (Default None).
  query: Query for photos, url-encoded (Default None).
  force_photos: If true, returns photo entries, even if album entries would
                typically be returned. The entries will be for all photos
                in each album.
  photo_title: Title of the photo(s) to return. Default None for all photos.</p>
<p>Returns:
  A list of entries, as specified above.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">album_entry</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">titles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span><span class="p">(</span><span class="n">titles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">query</span><span class="p">):</span>
      <span class="n">album_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetAlbum</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">titles</span><span class="o">=</span><span class="n">titles</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">photo_title</span> <span class="ow">or</span> <span class="n">query</span> <span class="ow">or</span> <span class="n">force_photos</span><span class="p">:</span>
      <span class="n">uri</span> <span class="o">=</span> <span class="s">&#39;/data/feed/api/user/&#39;</span> <span class="o">+</span> <span class="n">user</span>
      <span class="k">if</span> <span class="n">query</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">album_entry</span><span class="p">:</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetEntries</span><span class="p">(</span><span class="n">uri</span> <span class="o">+</span> <span class="s">&#39;?kind=photo&amp;q=&#39;</span> <span class="o">+</span> <span class="n">query</span><span class="p">,</span> <span class="n">photo_title</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">uri</span> <span class="o">+=</span> <span class="s">&#39;/albumid/</span><span class="si">%s</span><span class="s">?kind=photo&#39;</span>
        <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
          <span class="n">uri</span> <span class="o">+=</span> <span class="s">&#39;&amp;q=&#39;</span> <span class="o">+</span> <span class="n">query</span>
        <span class="k">for</span> <span class="n">album</span> <span class="ow">in</span> <span class="n">album_entry</span><span class="p">:</span>
          <span class="n">photo_entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetEntries</span><span class="p">(</span><span class="n">uri</span> <span class="o">%</span> <span class="n">album</span><span class="o">.</span><span class="n">gphoto_id</span><span class="o">.</span><span class="n">text</span><span class="p">,</span>
                                          <span class="n">photo_title</span><span class="p">)</span>
          <span class="n">entries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">photo_entries</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">entries</span> <span class="o">=</span> <span class="n">album_entry</span>

    <span class="k">return</span> <span class="n">entries</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>Create photo album</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">create_album</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">summary</span><span class="p">,</span> <span class="n">access</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>Args:
  title: Title of the album.
  summary: Summary or description of the album.
  access: Access level string. See the picasa package <strong>init</strong> file for
      valid values.
  date: Date on the album, as a string.  If eveluates to False, uses today.</p>
<p>Returns:
  AlbumEntry of newly created album.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="n">date</span><span class="p">:</span>
      <span class="n">parser</span> <span class="o">=</span> <span class="n">googlecl</span><span class="o">.</span><span class="n">calendar</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">DateParser</span><span class="p">()</span>
      <span class="n">date</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">determine_day</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">shift_dates</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">date</span><span class="p">:</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>
        <span class="n">timestamp_ms</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">((</span><span class="n">timestamp</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Could not parse date </span><span class="si">%s</span><span class="s">. (Picasa only takes day info)&#39;</span> <span class="o">%</span>
                  <span class="n">date</span><span class="p">)</span>
        <span class="n">timestamp_ms</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">timestamp_ms</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

    <span class="n">access</span> <span class="o">=</span> <span class="n">googlecl</span><span class="o">.</span><span class="n">picasa</span><span class="o">.</span><span class="n">_map_access_string</span><span class="p">(</span><span class="n">access</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">InsertAlbum</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">summary</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span>
                            <span class="n">access</span><span class="o">=</span><span class="n">access</span><span class="p">,</span>
                            <span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp_ms</span><span class="p">)</span>

  <span class="n">CreateAlbum</span> <span class="o">=</span> <span class="n">create_album</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>Download an album to the local host.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">download_album</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_path</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">video_format</span><span class="o">=</span><span class="s">&#39;mp4&#39;</span><span class="p">,</span> <span class="n">titles</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">photo_title</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>Keyword arguments:
  base_path: Path on the filesystem to copy albums to. Each album will
             be stored in base_path/<album title>. If base_path does not
             exist, it and each non-existent parent directory will be
             created.
  user: User whose albums are being retrieved. (Default 'default')
  titles: list or string Title(s) that the album(s) should have.
          Default None, for all albums.</p>
<p>Get download link and extension for photo or video.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_get_download_info</span><span class="p">(</span><span class="n">photo_or_video</span><span class="p">,</span> <span class="n">video_format</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>video_format must be in DOWNLOAD_VIDEO_TYPES.</p>
<p>Returns:
  (url, extension)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>      <span class="n">wanted_content</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="k">for</span> <span class="n">content</span> <span class="ow">in</span> <span class="n">photo_or_video</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">content</span><span class="o">.</span><span class="n">medium</span> <span class="o">==</span> <span class="s">&#39;image&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">wanted_content</span><span class="p">:</span>
          <span class="n">wanted_content</span> <span class="o">=</span> <span class="n">content</span>
        <span class="k">elif</span> <span class="n">content</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">DOWNLOAD_VIDEO_TYPES</span><span class="p">[</span><span class="n">video_format</span><span class="p">]:</span>
          <span class="n">wanted_content</span> <span class="o">=</span> <span class="n">content</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">wanted_content</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Did not find desired medium!&#39;</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;photo_or_video.media:</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">photo_or_video</span><span class="o">.</span><span class="n">media</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
      <span class="k">elif</span> <span class="n">wanted_content</span><span class="o">.</span><span class="n">medium</span> <span class="o">==</span> <span class="s">&#39;image&#39;</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">googlecl</span><span class="o">.</span><span class="n">picasa</span><span class="o">.</span><span class="n">make_download_url</span><span class="p">(</span><span class="n">photo_or_video</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">src</span><span class="p">)</span>
        <span class="n">mimetype</span> <span class="o">=</span> <span class="n">photo_or_video</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">type</span>
        <span class="n">extension</span> <span class="o">=</span> <span class="n">mimetype</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">wanted_content</span><span class="o">.</span><span class="n">url</span>
        <span class="n">extension</span> <span class="o">=</span> <span class="n">video_format</span>
      <span class="k">return</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">extension</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>End _get_download_info</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
      <span class="n">user</span> <span class="o">=</span> <span class="s">&#39;default&#39;</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetAlbum</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span> <span class="n">titles</span><span class="o">=</span><span class="n">titles</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">video_format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DOWNLOAD_VIDEO_TYPES</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
      <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Unsupported video format: &#39;</span> <span class="o">+</span> <span class="n">video_format</span><span class="p">)</span>
      <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Try one of the following video formats: &#39;</span> <span class="o">+</span>
               <span class="nb">str</span><span class="p">(</span><span class="n">DOWNLOAD_VIDEO_TYPES</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
      <span class="n">video_format</span> <span class="o">=</span> <span class="s">&#39;mp4&#39;</span>
      <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&#39;Downloading videos as &#39;</span> <span class="o">+</span> <span class="n">video_format</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">album</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
      <span class="n">album_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">safe_decode</span><span class="p">(</span><span class="n">album</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
      <span class="n">album_concat</span> <span class="o">=</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">album_path</span><span class="p">):</span>
        <span class="n">base_album_path</span> <span class="o">=</span> <span class="n">album_path</span>
        <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">album_path</span><span class="p">):</span>
          <span class="n">album_path</span> <span class="o">=</span> <span class="n">base_album_path</span> <span class="o">+</span> <span class="s">&#39;-</span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">album_concat</span>
          <span class="n">album_concat</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">album_path</span><span class="p">)</span>

      <span class="n">uri</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;/data/feed/api/user/</span><span class="si">%s</span><span class="s">/albumid/</span><span class="si">%s</span><span class="s">?kind=photo&#39;</span> <span class="o">%</span>
             <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">album</span><span class="o">.</span><span class="n">gphoto_id</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
      <span class="n">photo_entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetEntries</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">photo_title</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">photo_or_video</span> <span class="ow">in</span> <span class="n">photo_entries</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>TODO: Test on Windows (upload from one OS, download from another)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">photo_or_video_name</span> <span class="o">=</span> <span class="n">safe_decode</span><span class="p">(</span><span class="n">photo_or_video</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">photo_or_video_name</span> <span class="o">=</span> <span class="n">photo_or_video_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">extsep</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">url</span><span class="p">,</span> <span class="n">extension</span> <span class="o">=</span> <span class="n">_get_download_info</span><span class="p">(</span><span class="n">photo_or_video</span><span class="p">,</span> <span class="n">video_format</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">album_path</span><span class="p">,</span>
                            <span class="n">photo_or_video_name</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">extsep</span> <span class="o">+</span> <span class="n">extension</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>Check for a file extension, add it if it does not exist.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
          <span class="n">base_path</span> <span class="o">=</span> <span class="n">path</span>
          <span class="n">photo_concat</span> <span class="o">=</span> <span class="mi">1</span>
          <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">base_path</span> <span class="o">+</span> <span class="s">&#39;-</span><span class="si">%i</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">photo_concat</span>
            <span class="n">photo_concat</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">safe_encode</span><span class="p">(</span><span class="s">&#39;Downloading </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">safe_decode</span><span class="p">(</span><span class="n">photo_or_video</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span><span class="p">),</span> <span class="n">path</span><span class="p">)))</span>
        <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

  <span class="n">DownloadAlbum</span> <span class="o">=</span> <span class="n">download_album</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>Get albums from a user feed.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">get_album</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="n">titles</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>Keyword arguments:
  user: The user whose albums are being retrieved. (Default 'default')
  titles: list or string Title(s) that the album(s) should have.
          Default None, for all albums.</p>
<p>Returns:
  List of albums that match parameters, or [] if none do.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">uri</span> <span class="o">=</span> <span class="s">&#39;/data/feed/api/user/&#39;</span> <span class="o">+</span> <span class="n">user</span> <span class="o">+</span> <span class="s">&#39;?kind=album&#39;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetEntries</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">titles</span><span class="p">)</span>

  <span class="n">GetAlbum</span> <span class="o">=</span> <span class="n">get_album</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>Get a single album.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">get_single_album</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">uri</span> <span class="o">=</span> <span class="s">&#39;/data/feed/api/user/&#39;</span> <span class="o">+</span> <span class="n">user</span> <span class="o">+</span> <span class="s">&#39;?kind=album&#39;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">GetSingleEntry</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>

  <span class="n">GetSingleAlbum</span> <span class="o">=</span> <span class="n">get_single_album</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>Insert photos or videos into an album.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">insert_media_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">album</span><span class="p">,</span> <span class="n">media_list</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">,</span>
                        <span class="n">photo_name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">caption</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>Keyword arguments:
  album: The album entry of the album getting the media.
  media_list: A list of paths, each path a picture or video on
              the local host.
  tags: Text of the tags to be added to each item, e.g. 'Islands, Vacation'
        (Default '').
  caption: Caption/summary to give each item. Default None for no caption.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="n">album_url</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;/data/feed/api/user/</span><span class="si">%s</span><span class="s">/albumid/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                 <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">album</span><span class="o">.</span><span class="n">gphoto_id</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
    <span class="n">keywords</span> <span class="o">=</span> <span class="n">tags</span>
    <span class="k">if</span> <span class="n">caption</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">caption</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">failures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">media_list</span><span class="p">:</span>
      <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">safe_encode</span><span class="p">(</span><span class="s">&#39;Loading file &#39;</span> <span class="o">+</span> <span class="n">path</span> <span class="o">+</span> <span class="s">&#39; to album &#39;</span> <span class="o">+</span>
                           <span class="n">safe_decode</span><span class="p">(</span><span class="n">album</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">text</span><span class="p">)))</span>

      <span class="n">ext</span> <span class="o">=</span> <span class="n">googlecl</span><span class="o">.</span><span class="n">get_extension_from_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">ext</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;No extension match on path &#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">content_type</span> <span class="o">=</span> <span class="s">&#39;image/jpeg&#39;</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">content_type</span> <span class="o">=</span> <span class="n">SUPPORTED_VIDEO_TYPES</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
          <span class="n">content_type</span> <span class="o">=</span> <span class="s">&#39;image/&#39;</span> <span class="o">+</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
      <span class="n">title</span> <span class="o">=</span> <span class="n">photo_name</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">title</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">InsertPhotoSimple</span><span class="p">(</span><span class="n">album_url</span><span class="p">,</span>
                               <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                               <span class="n">summary</span><span class="o">=</span><span class="n">caption</span><span class="p">,</span>
                               <span class="n">filename_or_handle</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
                               <span class="n">keywords</span><span class="o">=</span><span class="n">keywords</span><span class="p">,</span>
                               <span class="n">content_type</span><span class="o">=</span><span class="n">content_type</span><span class="p">)</span>
      <span class="k">except</span> <span class="n">GooglePhotosException</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Failed to upload </span><span class="si">%s</span><span class="s">. (</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">)&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span>
                                                   <span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                   <span class="n">err</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">failures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">err</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>Don't let a stray error wreck an upload of 1000 photos</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">safe_encode</span><span class="p">(</span><span class="s">&#39;Unexpected error -- &#39;</span> <span class="o">+</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">err</span><span class="p">)))</span>
        <span class="n">failures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">failures</span><span class="p">:</span>
      <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">failures</span><span class="p">))</span> <span class="o">+</span> <span class="s">&#39; photos failed to upload&#39;</span><span class="p">)</span>
      <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">safe_encode</span><span class="p">(</span><span class="s">&#39;Failed files: &#39;</span> <span class="o">+</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">failures</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">failures</span>

  <span class="n">InsertMediaList</span> <span class="o">=</span> <span class="n">insert_media_list</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>Check that the token being used is valid.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">is_token_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_uri</span><span class="o">=</span><span class="s">&#39;/data/feed/api/user/default&#39;</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">return</span> <span class="n">googlecl</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">BaseCL</span><span class="o">.</span><span class="n">IsTokenValid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_uri</span><span class="p">)</span>

  <span class="n">IsTokenValid</span> <span class="o">=</span> <span class="n">is_token_valid</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>Add or remove tags on a list of photos.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">tag_photos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">photo_entries</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">caption</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>Keyword arguments:
  photo_entries: List of photo entry objects.
  tags: String representation of tags in a comma separated list.
        For how tags are generated from the string,
        see googlecl.base.generate_tag_sets(). Set None to leave the tags as
        they currently are.
  caption: New caption for the photo. Set None to leave the caption as it
      is.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="kn">from</span> <span class="nn">gdata.media</span> <span class="kn">import</span> <span class="n">Group</span><span class="p">,</span> <span class="n">Keywords</span>
    <span class="kn">from</span> <span class="nn">atom</span> <span class="kn">import</span> <span class="n">Summary</span>
    <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">remove_set</span><span class="p">,</span> <span class="n">add_set</span><span class="p">,</span> <span class="n">replace_tags</span> <span class="o">=</span> <span class="n">googlecl</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">generate_tag_sets</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">photo</span> <span class="ow">in</span> <span class="n">photo_entries</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">photo</span><span class="o">.</span><span class="n">media</span><span class="p">:</span>
          <span class="n">photo</span><span class="o">.</span><span class="n">media</span> <span class="o">=</span> <span class="n">Group</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">photo</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">keywords</span><span class="p">:</span>
          <span class="n">photo</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">keywords</span> <span class="o">=</span> <span class="n">Keywords</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>No point removing tags if the photo has no keywords,
or we're replacing the keywords.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="n">photo</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">text</span> <span class="ow">and</span> <span class="n">remove_set</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">replace_tags</span><span class="p">:</span>
          <span class="n">current_tags</span> <span class="o">=</span> <span class="n">photo</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">,</span> <span class="s">&#39;,&#39;</span><span class="p">)</span>
          <span class="n">current_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">current_tags</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">))</span>
          <span class="n">photo</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_set</span> <span class="o">-</span> <span class="n">remove_set</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">replace_tags</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">photo</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">text</span><span class="p">:</span>
          <span class="n">photo</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">add_set</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">add_set</span><span class="p">:</span>
          <span class="n">photo</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">text</span> <span class="o">+=</span> <span class="s">&#39;,&#39;</span> <span class="o">+</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">add_set</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">caption</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">photo</span><span class="o">.</span><span class="n">summary</span><span class="p">:</span>
          <span class="n">photo</span><span class="o">.</span><span class="n">summary</span> <span class="o">=</span> <span class="n">Summary</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">caption</span><span class="p">,</span> <span class="n">summary_type</span><span class="o">=</span><span class="s">&#39;text&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">photo</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">caption</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">UpdatePhotoMetadata</span><span class="p">(</span><span class="n">photo</span><span class="p">)</span>

  <span class="n">TagPhotos</span> <span class="o">=</span> <span class="n">tag_photos</span>


<span class="n">SERVICE_CLASS</span> <span class="o">=</span> <span class="n">PhotosServiceCL</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
